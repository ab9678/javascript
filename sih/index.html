<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart City Transport</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* --- GLOBAL DESIGN & THEME --- */
        :root {
            --primary-blue: #007BFF;
            --green: #28A745;
            --white: #ffffff;
            --light-gray: #f0f2f5;
            --dark-gray: #555;
            --black: #1c1c1e;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --border-radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--light-gray);
            color: var(--dark-gray);
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- DARK MODE --- */
        body.dark-mode {
            --light-gray: #1c1c1e;
            --white: #2c2c2e;
            --dark-gray: #f0f2f5;
            --black: #ffffff;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        #app-container {
            width: 100%;
            max-width: 450px;
            height: 100vh;
            max-height: 950px;
            background-color: var(--white);
            border-radius: 0;
            overflow: hidden;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
        }

        /* --- SCREEN MANAGEMENT --- */
        .screen {
            display: none;
            flex-direction: column;
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .screen.active {
            display: flex;
            opacity: 1;
            z-index: 10;
        }

        .screen-content {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
        }

        /* --- UI COMPONENTS --- */
        .btn {
            display: block;
            width: 100%;
            padding: 14px;
            border-radius: var(--border-radius);
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background-color: var(--primary-blue);
            color: #fff;
        }
        .btn-primary:hover { background-color: #0069d9; }

        .btn-green {
            background-color: var(--green);
            color: #fff;
        }
        .btn-green:hover { background-color: #218838; }
        
        .btn-secondary {
            background-color: var(--light-gray);
            color: var(--dark-gray);
            border: 1px solid #ddd;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1rem;
            background-color: var(--light-gray);
            color: var(--dark-gray);
        }

        .card {
            background-color: var(--white);
            padding: 16px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 1rem;
        }

        h1, h2, h3 { color: var(--black); }

        /* --- LOGIN & SPLASH --- */
        #splashScreen, #loginChoiceScreen {
            justify-content: center;
            align-items: center;
            text-align: center;
            background: linear-gradient(135deg, var(--primary-blue), var(--green));
            color: #fff;
        }
        #splashScreen h1, #loginChoiceScreen h1 {
            color: #fff;
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        #splashScreen p, #loginChoiceScreen p {
            font-size: 1.1rem;
            margin-bottom: 2rem;
        }
        .logo { font-size: 3rem; margin-bottom: 1rem; }
        .tab-switch {
            display: flex;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
        }
        .tab {
            flex: 1;
            padding: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .tab.active {
            background-color: #fff;
            color: var(--primary-blue);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        /* --- MAP STYLING --- */
        .map-container {
            height: 300px;
            width: 100%;
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 1rem;
        }
        #passengerHome .map-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 65%;
            border-radius: 0;
            z-index: 0;
        }

        /* --- PASSENGER HOME --- */
        #passengerHome .content-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 45%;
            background: var(--white);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 15px;
            z-index: 1;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
        }
        .filter-buttons { display: flex; gap: 10px; margin: 10px 0; }
        .filter-buttons .btn { flex: 1; padding: 10px; }

        /* --- DRIVER DASHBOARD --- */
        .online-toggle {
            padding: 15px;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: 700;
            box-shadow: var(--shadow);
        }
        .online-toggle.offline { background-color: var(--dark-gray); color: #fff; }
        .online-toggle.online { background-color: var(--green); color: #fff; }
        
        .driver-stats-card {
            text-align: center;
        }
        .driver-stats-card h2 {
            font-size: 2.5rem;
            color: var(--primary-blue);
        }

        /* --- RIDE TRACKING --- */
        #rideTrackingScreen .map-container {
            flex-grow: 1;
            margin-bottom: 0;
            border-radius: 0;
        }
        #rideTrackingScreen .tracking-info {
            padding: 20px;
            background: var(--white);
            box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
        }
        .driver-info-small { display: flex; align-items: center; gap: 15px; }
        .driver-info-small img { width: 50px; height: 50px; border-radius: 50%; }

        /* --- BOTTOM NAVIGATION --- */
        .bottom-nav {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            background-color: var(--white);
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
            margin-top: auto;
            border-top: 1px solid #eee;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--dark-gray);
            cursor: pointer;
            font-size: 0.8rem;
            border: none;
            background: none;
        }
        .nav-item i { font-size: 1.4rem; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary-blue); }

        /* --- INCOMING RIDE POPUP --- */
        #incomingRequestScreen {
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
        }
        .request-card {
            width: 90%;
            text-align: center;
        }
        .request-actions { display: flex; gap: 15px; margin-top: 1rem; }
        .request-actions .btn { flex: 1; }
        .btn-accept { background-color: var(--green); color: #fff; font-size: 1.5rem; }
        .btn-reject { background-color: #dc3545; color: #fff; font-size: 1.5rem; }

        /* --- PROFILE/SETTINGS --- */
        .profile-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--light-gray);
        }
        /* Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px; width: 20px;
            left: 4px; bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--primary-blue); }
        input:checked + .slider:before { transform: translateX(22px); }

        /* MEDIA QUERIES for Desktop */
        @media (min-width: 768px) {
            body { background-color: #e9ecef; }
            #app-container {
                margin: 2rem auto;
                border-radius: 20px;
                height: 90vh;
            }
        }
    </style>
</head>
<body>

    <div id="app-container">

        <div id="splashScreen" class="screen active">
            <div class="screen-content">
                <div class="logo"><i class="fas fa-bus-alt"></i></div>
                <h1>Smart City Transport</h1>
                <p>Greener Rides for Smart Cities</p>
                <button class="btn btn-secondary" onclick="showScreen('onboardingScreen')">Get Started</button>
            </div>
        </div>
        
        <div id="onboardingScreen" class="screen">
            <div class="screen-content" style="text-align: center;">
                 <i class="fas fa-map-marked-alt fa-3x" style="color: var(--primary-blue); margin-top: 2rem;"></i>
                 <h2 style="margin-top: 1rem;">Track Live Transport</h2>
                 <p>See buses and autos near you in real-time.</p>

                 <i class="fas fa-hand-holding-usd fa-3x" style="color: var(--green); margin-top: 2rem;"></i>
                 <h2 style="margin-top: 1rem;">Compare Fares</h2>
                 <p>Choose the most affordable ride for your destination.</p>

                 <i class="fas fa-shield-alt fa-3x" style="color: var(--primary-blue); margin-top: 2rem;"></i>
                 <h2 style="margin-top: 1rem;">Safe Travel</h2>
                 <p>Verified drivers and live ride sharing for your safety.</p>

                 <button class="btn btn-primary" style="margin-top: 3rem;" onclick="showScreen('loginChoiceScreen')">Next</button>
            </div>
        </div>

        <div id="loginChoiceScreen" class="screen">
            <div class="screen-content">
                <div class="logo"><i class="fas fa-bus-alt"></i></div>
                <h1>Welcome!</h1>
                <p>How would you like to continue?</p>
                <div style="margin-bottom: 1rem;">
                    <button class="btn btn-primary" onclick="setupLogin('passenger')">I'm a Passenger</button>
                </div>
                <div>
                    <button class="btn btn-secondary" onclick="setupLogin('driver')">I'm a Driver</button>
                </div>
            </div>
        </div>
        
        <div id="loginScreen" class="screen">
            <div class="screen-content">
                <h1 id="login-title" style="margin-bottom: 0.5rem;">Login as Passenger</h1>
                <p style="margin-bottom: 2rem;">Welcome back! Please enter your details.</p>
                
                <div class="tab-switch">
                    <div class="tab active" onclick="switchLoginTab(this, 'login-form')">Login</div>
                    <div class="tab" onclick="switchLoginTab(this, 'signup-form')">Sign Up</div>
                </div>

                <div id="login-form">
                    <div class="input-group">
                        <input type="email" placeholder="Email / Phone">
                    </div>
                    <div class="input-group">
                        <input type="password" placeholder="Password">
                    </div>
                    <a href="#" style="display:block; text-align:right; margin-bottom:1.5rem; color: var(--primary-blue);">Forgot Password?</a>
                    <button class="btn btn-primary" onclick="login()">Login</button>
                </div>

                <div id="signup-form" style="display:none;">
                    <div class="input-group">
                        <input type="text" placeholder="Full Name">
                    </div>
                    <div class="input-group">
                        <input type="email" placeholder="Email / Phone">
                    </div>
                    <div class="input-group">
                        <input type="password" placeholder="Create Password">
                    </div>
                     <div class="input-group" id="driver-fields" style="display:none;">
                        <label>Upload License (placeholder)</label>
                        <input type="file" disabled>
                        <label>Upload RC (placeholder)</label>
                        <input type="file" disabled>
                    </div>
                    <button class="btn btn-primary" onclick="login()">Sign Up</button>
                </div>

                <div style="text-align:center; margin: 1.5rem 0; color: #999;">OR</div>
                <button class="btn btn-secondary"><i class="fab fa-google"></i> Continue with Google</button>
                <button class="btn btn-secondary" style="margin-top: 2rem" onclick="showScreen('loginChoiceScreen')">
                    <i class="fas fa-exchange-alt"></i> Switch User Type
                </button>
            </div>
        </div>
        
        <div id="passengerHome" class="screen">
            <div id="passengerMap" class="map-container"></div>
            <div class="content-overlay">
                <div class="input-group">
                    <input type="text" placeholder="Enter Destination" onclick="showScreen('tripBookingScreen')">
                </div>
                <div class="filter-buttons">
                    <button class="btn btn-primary">Bus</button>
                    <button class="btn btn-secondary">Auto</button>
                    <button class="btn btn-secondary">Cab</button>
                </div>
                <div id="nearby-vehicles" style="overflow-y: auto; height: calc(100% - 110px);">
                    </div>
            </div>
            <div class="bottom-nav">
                 <button class="nav-item active" onclick="showPassengerScreen('passengerHome')"><i class="fas fa-home"></i> Home</button>
                 <button class="nav-item" onclick="showPassengerScreen('rideHistoryScreen')"><i class="fas fa-history"></i> History</button>
                 <button class="nav-item" onclick="showPassengerScreen('passengerProfileScreen')"><i class="fas fa-user"></i> Profile</button>
            </div>
        </div>

        <div id="tripBookingScreen" class="screen">
             <div class="screen-content">
                <button onclick="showPassengerScreen('passengerHome')" style="background:none; border:none; font-size: 1.2rem; margin-bottom: 1rem;"><i class="fas fa-arrow-left"></i> Back</button>
                <h2>Plan Your Trip</h2>
                <div class="input-group">
                    <label>Pickup Location</label>
                    <input type="text" value="My Current Location" disabled>
                </div>
                <div class="input-group">
                    <label>Drop Location</label>
                    <input type="text" placeholder="G.S. Road, Guwahati">
                </div>
                <hr style="margin: 1rem 0;">
                <h4>Suggested Routes</h4>
                <div class="card" onclick="showScreen('rideTrackingScreen')">
                    <div class="driver-info-small">
                        <img src="https://i.pravatar.cc/150?img=1" alt="Driver">
                        <div>
                            <strong>Bus #AS-01-1234</strong>
                            <p>Driver: Raj Sharma (5 yrs exp)</p>
                            <p style="color:var(--green); font-weight:600;">₹20 &bull; 5 min ETA</p>
                        </div>
                    </div>
                </div>
                 <div class="card" onclick="showScreen('rideTrackingScreen')">
                    <div class="driver-info-small">
                        <img src="https://i.pravatar.cc/150?img=2" alt="Driver">
                        <div>
                            <strong>Auto #AS-01-5678</strong>
                            <p>Driver: Priya Das (3 yrs exp)</p>
                            <p style="color:var(--green); font-weight:600;">₹80 &bull; 2 min ETA</p>
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="showScreen('rideTrackingScreen')">Book Selected Ride</button>
            </div>
        </div>
        
        <div id="rideTrackingScreen" class="screen">
            <div id="trackingMap" class="map-container"></div>
            <div class="tracking-info card">
                 <div class="driver-info-small">
                    <img src="https://i.pravatar.cc/150?img=1" alt="Driver">
                    <div>
                        <strong>Bus #AS-01-1234 is approaching</strong>
                        <p>Arriving in <span id="eta-countdown" style="font-weight:bold;">3:45</span></p>
                    </div>
                </div>
                <div style="display:flex; gap: 10px; margin-top:1rem;">
                    <button class="btn btn-secondary" style="flex:1;"><i class="fas fa-share-alt"></i> Share</button>
                    <button class="btn btn-secondary" style="background-color:#dc3545; color:#fff; flex:1;" onclick="cancelRide()"><i class="fas fa-times"></i> Cancel</button>
                    <button class="btn btn-secondary" style="background-color:#ffc107; color:#000; flex:1;"><i class="fas fa-exclamation-triangle"></i> SOS</button>
                </div>
            </div>
        </div>

        <div id="rideHistoryScreen" class="screen">
            <div class="screen-content">
                <h2>Ride History</h2>
                <div class="card">
                    <p><strong>From:</strong> Paltan Bazar</p>
                    <p><strong>To:</strong> Khanapara</p>
                    <p>Fare: ₹25 | Driver: Raj Sharma</p>
                    <button class="btn btn-secondary" style="margin-top:10px; padding: 8px;">Rebook</button>
                </div>
                <div class="card">
                    <p><strong>From:</strong> Chandmari</p>
                    <p><strong>To:</strong> Ganeshguri</p>
                    <p>Fare: ₹15 | Driver: Ankit Bora</p>
                    <button class="btn btn-secondary" style="margin-top:10px; padding: 8px;">Rebook</button>
                </div>
            </div>
             <div class="bottom-nav">
                 <button class="nav-item" onclick="showPassengerScreen('passengerHome')"><i class="fas fa-home"></i> Home</button>
                 <button class="nav-item active" onclick="showPassengerScreen('rideHistoryScreen')"><i class="fas fa-history"></i> History</button>
                 <button class="nav-item" onclick="showPassengerScreen('passengerProfileScreen')"><i class="fas fa-user"></i> Profile</button>
            </div>
        </div>

        <div id="passengerProfileScreen" class="screen">
            <div class="screen-content">
                <h2>Profile & Settings</h2>
                <div class="profile-item">
                    <span><i class="fas fa-user-edit"></i> Edit Profile</span>
                    <i class="fas fa-chevron-right"></i>
                </div>
                <div class="profile-item">
                    <span><i class="fas fa-language"></i> Language</span>
                    <span>English <i class="fas fa-chevron-down"></i></span>
                </div>
                <div class="profile-item">
                    <span><i class="fas fa-moon"></i> Dark Mode</span>
                    <label class="switch">
                        <input type="checkbox" id="darkModeToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                 <div class="profile-item">
                    <span><i class="fas fa-shield-alt"></i> Safety Guidelines</span>
                     <i class="fas fa-chevron-right"></i>
                </div>
                <button class="btn" style="background-color:#dc3545; color:#fff; margin-top:2rem;" onclick="logout()">Logout</button>
            </div>
             <div class="bottom-nav">
                 <button class="nav-item" onclick="showPassengerScreen('passengerHome')"><i class="fas fa-home"></i> Home</button>
                 <button class="nav-item" onclick="showPassengerScreen('rideHistoryScreen')"><i class="fas fa-history"></i> History</button>
                 <button class="nav-item active" onclick="showPassengerScreen('passengerProfileScreen')"><i class="fas fa-user"></i> Profile</button>
            </div>
        </div>


        <div id="driverDashboard" class="screen">
            <div class="screen-content">
                <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h2>Dashboard</h2>
                    <button id="onlineToggle" class="online-toggle offline" onclick="toggleOnlineStatus()">OFFLINE</button>
                </div>
                <div class="card driver-stats-card">
                    <p>Passengers Nearby</p>
                    <h2 id="nearby-passengers">5</h2>
                </div>
                <div class="card">
                    <h4>My Routes</h4>
                    <p>Paltan Bazar <i class="fas fa-long-arrow-alt-right"></i> Khanapara</p>
                </div>
                <button class="btn btn-green" onclick="simulateRideRequest()">Simulate Incoming Request</button>
            </div>
            <div class="bottom-nav">
                 <button class="nav-item active" onclick="showDriverScreen('driverDashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
                 <button class="nav-item" onclick="showDriverScreen('driverHistoryScreen')"><i class="fas fa-history"></i> History</button>
                 <button class="nav-item" onclick="showDriverScreen('driverProfileScreen')"><i class="fas fa-user-cog"></i> Profile</button>
            </div>
        </div>
        
        <div id="incomingRequestScreen" class="screen">
            <div class="card request-card">
                <h3>New Ride Request!</h3>
                <div id="requestMap" class="map-container" style="height: 200px; margin-top: 1rem;"></div>
                <p><strong>Pickup:</strong> Near ABC Hospital</p>
                <p><strong>Drop:</strong> City Center Mall</p>
                <h4 style="color:var(--green); margin-top:0.5rem;">Estimated Fare: ₹95</h4>
                <div class="request-actions">
                    <button class="btn btn-reject" onclick="showDriverScreen('driverDashboard')"><i class="fas fa-times"></i></button>
                    <button class="btn btn-accept" onclick="showDriverScreen('activeRideScreen')"><i class="fas fa-check"></i></button>
                </div>
            </div>
        </div>

        <div id="activeRideScreen" class="screen">
            <div id="driverNavMap" class="map-container" style="flex-grow: 1; border-radius: 0;"></div>
            <div class="card" style="margin: 0; border-radius: 0;">
                <h4>Trip to City Center Mall</h4>
                <p>Timer: 05:12 | Distance: 2.1 km</p>
                <div style="display:flex; gap: 10px; margin-top: 1rem;">
                    <button class="btn btn-primary" style="flex:2;" onclick="completeRide()">Complete Ride</button>
                    <button class="btn" style="flex:1; background-color:#ffc107; color:#000;"><i class="fas fa-exclamation-triangle"></i> SOS</button>
                </div>
            </div>
        </div>
        
        <div id="driverHistoryScreen" class="screen">
            <div class="screen-content">
                <h2>Completed Trips</h2>
                <div class="card">
                    <p><strong>Route:</strong> ABC Hospital to City Center</p>
                    <p><strong>Fare Collected:</strong> ₹95</p>
                    <p><strong>Passenger Rating:</strong> ★★★★★</p>
                </div>
                <div class="card">
                    <p><strong>Route:</strong> Railway Station to Fancy Bazar</p>
                    <p><strong>Fare Collected:</strong> ₹70</p>
                    <p><strong>Passenger Rating:</strong> ★★★★☆</p>
                </div>
            </div>
            <div class="bottom-nav">
                 <button class="nav-item" onclick="showDriverScreen('driverDashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
                 <button class="nav-item active" onclick="showDriverScreen('driverHistoryScreen')"><i class="fas fa-history"></i> History</button>
                 <button class="nav-item" onclick="showDriverScreen('driverProfileScreen')"><i class="fas fa-user-cog"></i> Profile</button>
            </div>
        </div>
        
        <div id="driverProfileScreen" class="screen">
            <div class="screen-content">
                 <h2>Driver Profile</h2>
                 <div class="card" style="text-align:center;">
                    <img src="https://i.pravatar.cc/150?img=5" alt="Driver" style="width:100px; height:100px; border-radius:50%;">
                    <h3>Ravi Kumar</h3>
                    <p>ID Verification: <span style="color:var(--green);"><i class="fas fa-check-circle"></i> Verified</span></p>
                 </div>
                 <div class="card">
                    <h4>Vehicle Details</h4>
                    <p><strong>Type:</strong> Auto Rickshaw</p>
                    <p><strong>Registration:</strong> AS-01-DT-4321</p>
                 </div>
                 <div class="card">
                    <h4>Documents</h4>
                    <p>Driving License: <span>license.pdf <i class="fas fa-eye"></i></span></p>
                    <p>RC Book: <span>rc_book.pdf <i class="fas fa-eye"></i></span></p>
                    <button class="btn btn-secondary" style="margin-top:10px; padding: 8px;">Upload New</button>
                 </div>
                 <button class="btn" style="background-color:#dc3545; color:#fff; margin-top:1rem;" onclick="logout()">Logout</button>
            </div>
            <div class="bottom-nav">
                 <button class="nav-item" onclick="showDriverScreen('driverDashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
                 <button class="nav-item" onclick="showDriverScreen('driverHistoryScreen')"><i class="fas fa-history"></i> History</button>
                 <button class="nav-item active" onclick="showDriverScreen('driverProfileScreen')"><i class="fas fa-user-cog"></i> Profile</button>
            </div>
        </div>
        
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- GLOBAL STATE ---
        let currentUserType = null; // 'passenger' or 'driver'
        let maps = {}; // To hold map instances
        const guwahatiCoords = [26.1445, 91.7362];

        // --- DUMMY DATA ---
        const nearbyVehicles = [
            { id: 1, type: 'Bus', driver: 'Raj Sharma', eta: 5, fare: 20, number: 'AS-01-1234', lat: 26.1455, lng: 91.7372 },
            { id: 2, type: 'Auto', driver: 'Priya Das', eta: 2, fare: 80, number: 'AS-01-5678', lat: 26.1435, lng: 91.7352 },
            { id: 3, type: 'Bus', driver: 'Ankit Bora', eta: 8, fare: 15, number: 'AS-01-9012', lat: 26.1465, lng: 91.7342 }
        ];

        // --- SCREEN NAVIGATION ---
        window.showScreen = (screenId) => {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            const activeScreen = document.getElementById(screenId);
            if (activeScreen) {
                activeScreen.classList.add('active');
            }

            // Initialize map if the screen has one
            if (screenId === 'passengerHome' && !maps.passengerMap) initMap('passengerMap', guwahatiCoords, true);
            if (screenId === 'rideTrackingScreen' && !maps.trackingMap) initMap('trackingMap', guwahatiCoords);
            if (screenId === 'incomingRequestScreen' && !maps.requestMap) initMap('requestMap', guwahatiCoords);
            if (screenId === 'activeRideScreen' && !maps.driverNavMap) initMap('driverNavMap', guwahatiCoords);
        };

        window.showPassengerScreen = (screenId) => {
            // Deactivate all nav items first
            document.querySelectorAll('#passengerHome .nav-item, #rideHistoryScreen .nav-item, #passengerProfileScreen .nav-item').forEach(item => item.classList.remove('active'));
            
            showScreen(screenId);
            
            // Activate the correct nav item
            let iconClass;
            if (screenId === 'passengerHome') iconClass = 'fa-home';
            if (screenId === 'rideHistoryScreen') iconClass = 'fa-history';
            if (screenId === 'passengerProfileScreen') iconClass = 'fa-user';
            
            document.querySelectorAll(`.nav-item .fa-${iconClass}`).forEach(icon => {
                icon.parentElement.classList.add('active');
            });
        };
        
        window.showDriverScreen = (screenId) => {
            document.querySelectorAll('#driverDashboard .nav-item, #driverHistoryScreen .nav-item, #driverProfileScreen .nav-item').forEach(item => item.classList.remove('active'));
            
            showScreen(screenId);
            
            let iconClass;
            if (screenId === 'driverDashboard') iconClass = 'fa-tachometer-alt';
            if (screenId === 'driverHistoryScreen') iconClass = 'fa-history';
            if (screenId === 'driverProfileScreen') iconClass = 'fa-user-cog';
            
            document.querySelectorAll(`.nav-item .fa-${iconClass}`).forEach(icon => {
                icon.parentElement.classList.add('active');
            });
        };

        // --- MAP INITIALIZATION ---
        const initMap = (mapId, center, showVehicles = false) => {
            if (maps[mapId]) return;

            const map = L.map(mapId).setView(center, 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap'
            }).addTo(map);

            // Add user's location marker
            L.marker(center, {
                icon: L.divIcon({
                    className: 'user-location-marker',
                    html: '<div style="background-color: #007BFF; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>',
                    iconSize: [20, 20],
                })
            }).addTo(map);

            if (showVehicles) {
                addVehicleMarkers(map);
            }
            maps[mapId] = map;
            
            // Invalidate size after a short delay to ensure correct rendering
            setTimeout(() => map.invalidateSize(), 100);
        };
        
        const addVehicleMarkers = (map) => {
            const busIcon = L.icon({
                iconUrl: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzAwN0JGRiIgd2lkdGg9IjM2cHgiIGhlaWdodD0iMzZweCI+PHBhdGggZD0iTTAgMGgyNHYyNEgweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik0yMCAySDhDMi41IDIgMiAxMCAyIDEwaDJ2MmgxNnYtMmgxYzEuMSAwIDItLjkgMi0yVjRjMC0xLjEtLjktMi0yLTJ6bTAgOEg0di0yYzAtNC40MSAzLjU5LTggOC04aDR2MTB6bS00LTYuNWMyLjQ5IDAgNC41IDIuMDEgNC41IDQuNVMxOC40OSAxOCAxNiAxOCAxMS41IDE1Ljk5IDExLjUgMTMuNSAxMy41MSA5IDE2IDl6bTAgNWMxLjM4IDAgMi41LTEuMTIgMi41LTIuNVMxNy4zOCAxMSAxNiAxMXMtMi41IDEuMTItMi41IDIuNSAxLjEyIDIuNSAyLjUgMi41eiIvPjwvc3ZnPg==',
                iconSize: [36, 36],
                iconAnchor: [18, 36],
            });
             const autoIcon = L.icon({
                iconUrl: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzI4QTc0NSIgd2lkdGg9IjM2cHgiIGhlaWdodD0iMzZweCI+PHBhdGggZD0iTTAgMGgyNHYyNEgweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik0xOC45MiA2LjAxQzE4LjcxIDYuMDQgMTguNSA2IDE4IDZINGMtLjQ2IDAtLjguMzYtLjkuODJsLTIgMTFjLS4wNy4zNS4wMS43Mi4yOC45OGwuMDYuMDVDMiA5IDIuNSA3IDQgN2g1Yy0xLjU1IDAtMyAxLjQ4LTMgMy41bDUtMS41di0yLjVjMC0xLjM4IDEuMTItMi41IDIuNS0yLjVoMi4yOGMuMzkgMCAuNzQuMjQuOS42MXpNMTEgMTRjLTEuMSAwLTItLjktMi0ycy45LTIgMi0yIDIgLjkgMiAyLS45IDItMiAyes0xOCAxNGMtMS4xIDAtMi0uOS0yLTJzLjktMiAyLTIgMiAuOSAyIDItLjkgMi0yIDJ6Ii8+PC9zdmc+',
                iconSize: [36, 36],
                iconAnchor: [18, 36],
            });

            nearbyVehicles.forEach(vehicle => {
                L.marker([vehicle.lat, vehicle.lng], { icon: vehicle.type === 'Bus' ? busIcon : autoIcon })
                 .addTo(map)
                 .bindPopup(`<b>${vehicle.type}</b> #${vehicle.number}<br>Driver: ${vehicle.driver}`);
            });
        };

        // --- AUTH & SETUP ---
        window.setupLogin = (userType) => {
            currentUserType = userType;
            const title = document.getElementById('login-title');
            const driverFields = document.getElementById('driver-fields');
            title.textContent = `Login as ${userType.charAt(0).toUpperCase() + userType.slice(1)}`;
            driverFields.style.display = userType === 'driver' ? 'block' : 'none';
            showScreen('loginScreen');
        };

        window.switchLoginTab = (tabElement, formId) => {
            document.querySelectorAll('.tab-switch .tab').forEach(t => t.classList.remove('active'));
            tabElement.classList.add('active');
            
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('signup-form').style.display = 'none';
            document.getElementById(formId).style.display = 'block';
        };

        window.login = () => {
            if (currentUserType === 'passenger') {
                showPassengerScreen('passengerHome');
                populateNearbyVehicles();
            } else {
                showDriverScreen('driverDashboard');
            }
        };

        window.logout = () => {
            currentUserType = null;
            showScreen('loginChoiceScreen');
        };
        
        // --- PASSENGER LOGIC ---
        const populateNearbyVehicles = () => {
            const container = document.getElementById('nearby-vehicles');
            container.innerHTML = '<h4>Nearby Vehicles</h4>';
            nearbyVehicles.forEach(v => {
                container.innerHTML += `
                    <div class="card" onclick="showScreen('tripBookingScreen')">
                        <strong>${v.type} #${v.number}</strong>
                        <p>ETA: ${v.eta} mins | Fare: ₹${v.fare}</p>
                    </div>
                `;
            });
        };

        let etaInterval;
        document.querySelector('#rideTrackingScreen .btn-primary, #tripBookingScreen .btn').addEventListener('click', () => {
            // Start countdown simulation
            let seconds = 225; // 3:45
            const countdownEl = document.getElementById('eta-countdown');
            etaInterval = setInterval(() => {
                seconds--;
                const minutes = Math.floor(seconds / 60);
                const remSeconds = seconds % 60;
                countdownEl.textContent = `${minutes}:${remSeconds < 10 ? '0' : ''}${remSeconds}`;
                if (seconds <= 0) {
                    clearInterval(etaInterval);
                    countdownEl.textContent = 'Arrived!';
                    setTimeout(showBoardingConfirmation, 1000);
                }
            }, 1000);
        });
        
        const showBoardingConfirmation = () => {
            if(confirm("Bus has arrived. Are you boarding?")) {
                alert("Ride completed and saved to history!");
                showPassengerScreen('passengerHome');
            } else {
                alert("Ride cancelled.");
                showPassengerScreen('passengerHome');
            }
        };

        window.cancelRide = () => {
            clearInterval(etaInterval);
            alert("Ride has been cancelled.");
            showPassengerScreen('passengerHome');
        };

        // --- DRIVER LOGIC ---
        window.toggleOnlineStatus = () => {
            const toggle = document.getElementById('onlineToggle');
            if (toggle.classList.contains('offline')) {
                toggle.classList.remove('offline');
                toggle.classList.add('online');
                toggle.textContent = 'ONLINE';
            } else {
                toggle.classList.remove('online');
                toggle.classList.add('offline');
                toggle.textContent = 'OFFLINE';
            }
        };
        
        setInterval(() => {
            const countEl = document.getElementById('nearby-passengers');
            let currentCount = parseInt(countEl.textContent);
            let change = Math.random() > 0.5 ? 1 : -1;
            let newCount = Math.max(0, currentCount + change);
            countEl.textContent = newCount;
        }, 5000);

        window.simulateRideRequest = () => {
            const toggle = document.getElementById('onlineToggle');
            if(toggle.classList.contains('offline')) {
                alert("You are offline. Please go online to receive requests.");
                return;
            }
            showScreen('incomingRequestScreen');
        };
        
        window.completeRide = () => {
            alert("Ride completed!");
            showDriverScreen('driverDashboard');
        }

        // --- SETTINGS ---
        document.getElementById('darkModeToggle').addEventListener('change', (event) => {
            if (event.target.checked) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        });

    });
    </script>
</body>
</html>